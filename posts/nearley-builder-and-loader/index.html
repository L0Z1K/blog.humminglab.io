<!doctype html><html lang=en><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=robots content="noodp"><title>Nearley 로 설정용 파서 만들기 - All about IoT</title><meta name=Description content><meta property="og:title" content="Nearley 로 설정용 파서 만들기"><meta property="og:description" content="이 문서에서는 Nearley parsing toolkit 을 이용하여 IoT 기기에서 사용할 설정 정보의 binary pack 및 loader 를 생성하는 방법을 설명한다.
예를 들어 아래와 같은 간단한 문법을 정의하고, 이를 Nearley 로 parser를 만들어 구분 분석을 하여, 디바이스에 로드할 수 있는 바이너리 데이터로 변환을 한다. 그리고, 변환된 바이너리 파일을 장치에서 로드하여 설정 정보를 얻는다.
1 2 3 4 5 6 7 topic/test1 { temperature I8; humidity U8; pressure U16; timestamp U32; name STR[12]; } 배경아래 그림과 같이 IoT 기기는 기기 고유의 컨트롤을 담당하는 Host MCU와 별도의 Wi-Fi 모듈로 IoT 기능을 구현하는 경우가 많다."><meta property="og:type" content="article"><meta property="og:url" content="https://blog.humminglab.io/posts/nearley-builder-and-loader/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2022-01-04T19:00:00+09:00"><meta property="article:modified_time" content="2021-01-04T19:00:00+09:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="Nearley 로 설정용 파서 만들기"><meta name=twitter:description content="이 문서에서는 Nearley parsing toolkit 을 이용하여 IoT 기기에서 사용할 설정 정보의 binary pack 및 loader 를 생성하는 방법을 설명한다.
예를 들어 아래와 같은 간단한 문법을 정의하고, 이를 Nearley 로 parser를 만들어 구분 분석을 하여, 디바이스에 로드할 수 있는 바이너리 데이터로 변환을 한다. 그리고, 변환된 바이너리 파일을 장치에서 로드하여 설정 정보를 얻는다.
1 2 3 4 5 6 7 topic/test1 { temperature I8; humidity U8; pressure U16; timestamp U32; name STR[12]; } 배경아래 그림과 같이 IoT 기기는 기기 고유의 컨트롤을 담당하는 Host MCU와 별도의 Wi-Fi 모듈로 IoT 기능을 구현하는 경우가 많다."><meta name=application-name content="All about IoT"><meta name=apple-mobile-web-app-title content="All about IoT"><meta name=theme-color content="#f8f8f8"><link rel="shortcut icon" type=image/x-icon href=/favicon.ico><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=canonical href=https://blog.humminglab.io/posts/nearley-builder-and-loader/><link rel=prev href=https://blog.humminglab.io/posts/yocto-project-on-orange-pi-1/><link rel=next href=https://blog.humminglab.io/posts/yocto-project-on-orange-pi-2/><link rel=stylesheet href=/lib/normalize/normalize.min.css><link rel=stylesheet href=/css/color.css><link rel=stylesheet href=/css/style.min.css><link rel=preload as=style onload='this.onload=null,this.rel="stylesheet"' href=/lib/fontawesome-free/all.min.css><noscript><link rel=stylesheet href=/lib/fontawesome-free/all.min.css></noscript><link rel=preload as=style onload='this.onload=null,this.rel="stylesheet"' href=/lib/animate/animate.min.css><noscript><link rel=stylesheet href=/lib/animate/animate.min.css></noscript><script type=application/ld+json>{"@context":"http://schema.org","@type":"BlogPosting","headline":"Nearley 로 설정용 파서 만들기","inLanguage":"en","mainEntityOfPage":{"@type":"WebPage","@id":"https:\/\/blog.humminglab.io\/posts\/nearley-builder-and-loader\/"},"genre":"posts","keywords":"Nearley, Parser, JavaScript, C","wordcount":1329,"url":"https:\/\/blog.humminglab.io\/posts\/nearley-builder-and-loader\/","datePublished":"2022-01-04T19:00:00+09:00","dateModified":"2021-01-04T19:00:00+09:00","publisher":{"@type":"Organization","name":"HummingLab"},"authors":[{"@type":"Person","name":"YSLee"}],"description":""}</script><script src=//instant.page/5.1.1 defer type=module integrity=sha384-MWfCL6g1OTGsbSwfuMHc8+8J2u71/LA8dzlIN3ycajckxuZZmF+DNjdm7O6H3PSq></script></head><body header-desktop header-mobile><script type=text/javascript>function setTheme(e){document.body.setAttribute("theme",e),document.documentElement.style.setProperty("color-scheme",e==="light"?"light":"dark"),window.theme=e}function saveTheme(e){window.localStorage&&localStorage.setItem("theme",e)}function getMeta(e){const t=document.getElementsByTagName("meta");for(let n=0;n<t.length;n++)if(t[n].getAttribute("name")===e)return t[n];return""}if(window.localStorage&&localStorage.getItem("theme")){let e=localStorage.getItem("theme");e==="light"||e==="dark"||e==="black"?setTheme(e):setTheme(window.matchMedia&&window.matchMedia("(prefers-color-scheme: dark)").matches?"dark":"light")}else""==="light"||""==="dark"||""==="black"?(setTheme(""),saveTheme("")):(saveTheme("auto"),setTheme(window.matchMedia&&window.matchMedia("(prefers-color-scheme: dark)").matches?"dark":"light"));let metaColors={light:"#f8f8f8",dark:"#252627",black:"#000000"};getMeta("theme-color").content=metaColors[document.body.getAttribute("theme")]</script><div id=back-to-top></div><div id=mask></div><div class=wrapper><header class=desktop id=header-desktop><div class=header-wrapper><div class=header-title><a href=/ title="All about IoT">All about IoT</a></div><div class=menu><div class=menu-inner><a class=menu-item href=/posts/>Posts </a><a class=menu-item href=/tags/>Tags </a><a class=menu-item href=/categories/>Categories </a><a class=menu-item href=https://www.humminglab.io/ rel="noopener noreferrer" target=_blank>HummingLab </a><span class="menu-item delimiter"></span><a href=# class="menu-item theme-switch" title="Switch Theme">
<i class="fas fa-adjust fa-fw"></i></a></div></div></div></header><header class=mobile id=header-mobile><div class=header-container><div class=header-wrapper><div class=header-title><a href=/ title="All about IoT">All about IoT</a></div><div class=menu-toggle id=menu-toggle-mobile><span></span><span></span><span></span></div></div><div class=menu id=menu-mobile><a class=menu-item href=/posts/ title>Posts</a><a class=menu-item href=/tags/ title>Tags</a><a class=menu-item href=/categories/ title>Categories</a><a class=menu-item href=https://www.humminglab.io/ title rel="noopener noreferrer" target=_blank>HummingLab</a><a href=# class="menu-item theme-switch" title="Switch Theme">
<i class="fas fa-adjust fa-fw"></i></a></div></div></header><div class="search-dropdown desktop"><div id=search-dropdown-desktop></div></div><div class="search-dropdown mobile"><div id=search-dropdown-mobile></div></div><main class=main><div class=container><div class=toc id=toc-auto><h2 class=toc-title>Contents</h2><div class=toc-content id=toc-content-auto><nav id=TableOfContents><ul><li><a href=#배경>배경</a></li><li><a href=#nearley>Nearley</a></li><li><a href=#parser-구현>Parser 구현</a><ul><li><a href=#parser의-입렵-및-출력-결과물>Parser의 입렵 및 출력 결과물</a></li><li><a href=#parser-작성>Parser 작성</a></li><li><a href=#parser-동작-검증>Parser 동작 검증</a></li><li><a href=#바이너리로-변환>바이너리로 변환</a></li></ul></li><li><a href=#빌더-만들기>빌더 만들기</a></li></ul></nav></div></div><script>document.getElementsByTagName("main")[0].setAttribute("pageStyle","normal")</script><script>document.getElementsByTagName("main")[0].setAttribute("autoTOC","true")</script><article class="page single"><h1 class="single-title animate__animated animate__flipInX">Nearley 로 설정용 파서 만들기</h1><div class=post-meta><div class=post-meta-line><span class=post-author><span class=author><i class="author fas fa-user-circle fa-fw"></i><span class=screen-reader-text> </span><a href=https://blog.humminglab.io/authors/yslee>YSLee</a></span>
</span>&nbsp;<span class=post-category>included in </span>&nbsp;<span class=post-category>category <a href=/categories/development/><i class="far fa-folder fa-fw"></i>Development</a></span></div><div class=post-meta-line><i class="far fa-calendar-alt fa-fw"></i>&nbsp;<time datetime=2022-01-04>2022-01-04</time>&nbsp;<i class="far fa-edit fa-fw"></i>&nbsp;<time datetime=2021-01-04>2021-01-04</time>&nbsp;<i class="fas fa-pencil-alt fa-fw"></i>&nbsp;1329 words&nbsp;
<i class="far fa-clock fa-fw"></i>&nbsp;7 minutes&nbsp;</div></div><div class="details toc" id=toc-static kept><div class="details-summary toc-title"><span>Contents</span>
<span><i class="details-icon fas fa-angle-right"></i></span></div><div class="details-content toc-content" id=toc-content-static><nav id=TableOfContents><ul><li><a href=#배경>배경</a></li><li><a href=#nearley>Nearley</a></li><li><a href=#parser-구현>Parser 구현</a><ul><li><a href=#parser의-입렵-및-출력-결과물>Parser의 입렵 및 출력 결과물</a></li><li><a href=#parser-작성>Parser 작성</a></li><li><a href=#parser-동작-검증>Parser 동작 검증</a></li><li><a href=#바이너리로-변환>바이너리로 변환</a></li></ul></li><li><a href=#빌더-만들기>빌더 만들기</a></li></ul></nav></div></div><div class=content id=content><p>이 문서에서는 <a href=https://nearley.js.org/ target=_blank rel="noopener noreferrer">Nearley</a> parsing toolkit 을 이용하여 IoT 기기에서 사용할 설정 정보의 binary pack 및 loader 를 생성하는 방법을 설명한다.</p><p>예를 들어 아래와 같은 간단한 문법을 정의하고, 이를 Nearley 로 parser를 만들어 구분 분석을 하여, 디바이스에 로드할 수 있는 바이너리 데이터로 변환을 한다.
그리고, 변환된 바이너리 파일을 장치에서 로드하여 설정 정보를 얻는다.</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>topic/test1 {
</span></span><span class=line><span class=cl>    temperature I8;
</span></span><span class=line><span class=cl>    humidity U8;
</span></span><span class=line><span class=cl>    pressure U16;
</span></span><span class=line><span class=cl>    timestamp U32;
</span></span><span class=line><span class=cl>    name STR[12];
</span></span><span class=line><span class=cl>}
</span></span></code></pre></td></tr></table></div></div><h2 id=배경 class=headerLink><a href=#%eb%b0%b0%ea%b2%bd class=header-mark></a>배경</h2><p>아래 그림과 같이 IoT 기기는 기기 고유의 컨트롤을 담당하는 Host MCU와 별도의 Wi-Fi 모듈로 IoT 기능을 구현하는 경우가 많다.
이 경우 Host MCU와 IoT 모듈 사이에는 AT 명령 등을 이용하여 제어를 한다.</p><figure><a class=lightgallery href=/posts/nearley-builder-and-loader/iot-general.png title=/posts/nearley-builder-and-loader/iot-general.png data-thumbnail=/posts/nearley-builder-and-loader/iot-general.png data-sub-html="<h2>IoT 연결 구성도</h2>"><img loading=lazy src=/posts/nearley-builder-and-loader/iot-general.png srcset="/posts/nearley-builder-and-loader/iot-general.png, /posts/nearley-builder-and-loader/iot-general.png 1.5x, /posts/nearley-builder-and-loader/iot-general.png 2x" sizes=auto alt=/posts/nearley-builder-and-loader/iot-general.png height=auto width=600px></a><figcaption class=image-caption>IoT 연결 구성도</figcaption></figure><p>IoT 서비스의 경우 보통 외부 서버와 MQTT protocol 을 통하여 JSON 형식의 데이타를 주고 받는다. Host MCU에서 이를 직접 처리를 하면 좋겠지만, 수 Kbytes의 작은 메모리를 가진 MCU 로 한계가 있을 수 있다. 대안으로 MQTT, JSON 처리를 모두 Wi-Fi 에서 처리하여 Host에는 C 구조체로 바로 매핑가능한 binary 형식으로 전달할 수 있다. 하지만 JSON-to-C 또는 C-to-JSON 변환 룰이 고정된 경우 사양이 변경될 때마다 매번 HOST, WiFi를 업그레이드를 하여야 한다.</p><p>여기에서는 빌드된 바이너리 설정 정보를 WiFi 모듈에 로드하여, 이를 이용하여 동적으로 C &lt;=> JSON 을 변환을 하는 기능을 만든다. 이렇게 된다면 WiFi 모듈은 변경없이 HOST MCU 만 변경하여 새로운 데이타 형식 지원이 가능하게 된다.</p><p>간단하게 절차를 정리하면 다음과 같이 된다.</p><ul><li>개발용 PC 에서 설정파일 작성</li><li>이를 빌드하여 Wi-Fi 모듈에 로드할 binary 데이타와 C 참조 소스 생성</li><li>Host MCU에서 이 정보를 가지고 있고, 이를 초기 실행 시 WiFi 모듈에 로드</li></ul><p>이와는 용도가 다르지만 parser 사용이 필요한 경우 아래 내용을 참고해 볼 수 있을 것이다.</p><h2 id=nearley class=headerLink><a href=#nearley class=header-mark></a>Nearley</h2><p><a href=https://nearley.js.org/ target=_blank rel="noopener noreferrer">Nearley</a> 는 Javascript 용 parsing toolkit 으로, 이를 이용하면 작성한 구문을 원하는 형식에 맞추어 token 으로 분리할 수 있다.
특히 Nearley의 경우 이들 토큰에 대한 post processing이 간편하여 짧은 코드로 분리한 token을 기반으로 원하는 정보를 만들어 낼 수 있다.</p><p>사용 방법은 다음과 같은 단계를 거쳐서 진행한다.</p><ul><li><a href=https://nearley.js.org/docs/grammar target=_blank rel="noopener noreferrer">Nearley syntax</a> 형식으로 parser의 문법을 작성하여 확장자 .ne 로 저장</li><li>이를 <code>nearleyc</code> 를 이용하여 compile 하여 javascript 소스 생성</li><li><code>nearley</code> 패키지를 이용하여 위에서 생성한 javascript를 로드하여 이를 이용하여 문법을 파싱하는 기능을 만든다.</li></ul><p>기본적인 사용 방법은 Nearley의 <a href=https://nearley.js.org/docs/getting-started#nearley-in-3-steps target=_blank rel="noopener noreferrer">Getting Started</a> 부터 참고해 볼 수 있다.</p><h2 id=parser-구현 class=headerLink><a href=#parser-%ea%b5%ac%ed%98%84 class=header-mark></a>Parser 구현</h2><p>관련 소스는 <a href=https://github.com/humminglab/nearley-dev-conf target=_blank rel="noopener noreferrer">Github nearley-dev-conf</a> 를 참조할 수 있다.</p><h3 id=parser의-입렵-및-출력-결과물 class=headerLink><a href=#parser%ec%9d%98-%ec%9e%85%eb%a0%b5-%eb%b0%8f-%ec%b6%9c%eb%a0%a5-%ea%b2%b0%ea%b3%bc%eb%ac%bc class=header-mark></a>Parser의 입렵 및 출력 결과물</h3><p>작성하려는 parser는 아래와 같이 MQTT topic 이름과 C 구조체와 유사한 형식의 데이타로 구성된 데이타의 구문 분석기 이다.
특별한 의미는 없지만 C 와는 다르게 data type을 뒤에 있도록 하였다.</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>topic/test1 {
</span></span><span class=line><span class=cl>    temperature I8;
</span></span><span class=line><span class=cl>    humidity U8;
</span></span><span class=line><span class=cl>    pressure U16;
</span></span><span class=line><span class=cl>    timestamp U32;
</span></span><span class=line><span class=cl>    name STR[12];
</span></span><span class=line><span class=cl>}
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>topic/array_object {
</span></span><span class=line><span class=cl>    name STR[12];
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    node[4] {
</span></span><span class=line><span class=cl>        subname STR[12];
</span></span><span class=line><span class=cl>        info {
</span></span><span class=line><span class=cl>            temperature I8;
</span></span><span class=line><span class=cl>            humidity U8;
</span></span><span class=line><span class=cl>        }
</span></span><span class=line><span class=cl>    }
</span></span><span class=line><span class=cl>}
</span></span></code></pre></td></tr></table></div></div><p>이를 이용하여 WiFi 모듈에서 JSON &lt;=> C 로 변환할 정보를 생성하고, Host MCU 에서 참고할 C 소스 코드를 생성한다.</p><h3 id=parser-작성 class=headerLink><a href=#parser-%ec%9e%91%ec%84%b1 class=header-mark></a>Parser 작성</h3><p>위 입력을 parsing 하기 위한 ne 파일은 다음과 같다.</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span><span class=lnt>57
</span><span class=lnt>58
</span><span class=lnt>59
</span><span class=lnt>60
</span><span class=lnt>61
</span><span class=lnt>62
</span><span class=lnt>63
</span><span class=lnt>64
</span><span class=lnt>65
</span><span class=lnt>66
</span><span class=lnt>67
</span><span class=lnt>68
</span><span class=lnt>69
</span><span class=lnt>70
</span><span class=lnt>71
</span><span class=lnt>72
</span><span class=lnt>73
</span><span class=lnt>74
</span><span class=lnt>75
</span><span class=lnt>76
</span><span class=lnt>77
</span><span class=lnt>78
</span><span class=lnt>79
</span><span class=lnt>80
</span><span class=lnt>81
</span><span class=lnt>82
</span><span class=lnt>83
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>input -&gt; _ templates _ 
</span></span><span class=line><span class=cl>    {% 
</span></span><span class=line><span class=cl>        (data) =&gt; {
</span></span><span class=line><span class=cl>            return { templates: data[1] };
</span></span><span class=line><span class=cl>        } 
</span></span><span class=line><span class=cl>    %}
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>templates 
</span></span><span class=line><span class=cl>    -&gt; template {% (data) =&gt; [data[0]] %}
</span></span><span class=line><span class=cl>    | template _ templates {% (data) =&gt; [data[0], ...data[2]] %}
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>template 
</span></span><span class=line><span class=cl>    -&gt; key _ &#34;{&#34; _ statements _ &#34;}&#34;
</span></span><span class=line><span class=cl>    {% 
</span></span><span class=line><span class=cl>        (data) =&gt; { return {type: &#34;TEMPLATE&#34;, name: data[0], data: data[4]}; }
</span></span><span class=line><span class=cl>    %}
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>statements 
</span></span><span class=line><span class=cl>    -&gt; statement {% (data) =&gt; [data[0]] %}
</span></span><span class=line><span class=cl>    | statement _ statements {% (data) =&gt; [data[0], ...data[2]] %}
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>statement 
</span></span><span class=line><span class=cl>    -&gt; key _ basic_data_type _ &#34;;&#34; 
</span></span><span class=line><span class=cl>    {% 
</span></span><span class=line><span class=cl>        (data) =&gt; {
</span></span><span class=line><span class=cl>            data[2][&#39;name&#39;] = data[0];
</span></span><span class=line><span class=cl>            return data[2];
</span></span><span class=line><span class=cl>        }
</span></span><span class=line><span class=cl>    %}
</span></span><span class=line><span class=cl>    | key _ &#34;{&#34; _ statements _ &#34;}&#34; _ &#34;;&#34;
</span></span><span class=line><span class=cl>    {%
</span></span><span class=line><span class=cl>        (data) =&gt; {
</span></span><span class=line><span class=cl>            return {type: &#34;OBJECT&#34;, name: data[0], data: data[4]}; 
</span></span><span class=line><span class=cl>        }
</span></span><span class=line><span class=cl>    %}
</span></span><span class=line><span class=cl>    | key _ &#34;[&#34; _ number _ &#34;]&#34; _ &#34;{&#34; _ statements _ &#34;}&#34; _ &#34;;&#34; 
</span></span><span class=line><span class=cl>    {% 
</span></span><span class=line><span class=cl>        (data) =&gt; {
</span></span><span class=line><span class=cl>            return {type: &#34;ARRAY&#34;, name: data[0], length: data[4], data: data[10]};
</span></span><span class=line><span class=cl>        }
</span></span><span class=line><span class=cl>    %}
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>basic_data_type
</span></span><span class=line><span class=cl>    -&gt; basic_type {% (data) =&gt; { return {type: data[0][0], length: 0}; } %}
</span></span><span class=line><span class=cl>    | basic_type _ &#34;(&#34; _ number _ &#34;)&#34; {% (data) =&gt; { return {type: data[0][0], length: Number(data[4])}; } %}
</span></span><span class=line><span class=cl>    | fixed_type_prefix _ &#34;[&#34; _ number _ &#34;]&#34; {% (data) =&gt; { data[0].length = Number(data[4]); return data[0]; } %}
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>fixed_type_prefix
</span></span><span class=line><span class=cl>    -&gt; &#34;STR&#34; {% () =&gt; { return {type: &#34;FIX_STR&#34;}; } %}
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>basic_type
</span></span><span class=line><span class=cl>    -&gt; &#34;I8&#34;
</span></span><span class=line><span class=cl>    | &#34;U8&#34;
</span></span><span class=line><span class=cl>    | &#34;I16&#34;
</span></span><span class=line><span class=cl>    | &#34;U16&#34;
</span></span><span class=line><span class=cl>    | &#34;I32&#34;
</span></span><span class=line><span class=cl>    | &#34;U32&#34;
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>key -&gt; key_character_first key_character:*  {% (data) =&gt; data[0] + data[1].join(&#34;&#34;) %}
</span></span><span class=line><span class=cl>key_character_first -&gt; [_\-a-zA-Z]   {% id %}
</span></span><span class=line><span class=cl>key_character -&gt; [_\-a-zA-Z0-9/] {% id %}
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>number 
</span></span><span class=line><span class=cl>    -&gt; digits {% (data) =&gt; Number(data[0])  %}
</span></span><span class=line><span class=cl>    | digits &#34;.&#34; digits {% (data) =&gt; Number(data[0] + &#34;.&#34; + data[2]) %}
</span></span><span class=line><span class=cl>    | &#34;0&#34; [xX] hexs {% (data) =&gt; parseInt(data[2], 16) %}
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>hexs 
</span></span><span class=line><span class=cl>    -&gt; hex {% id %}
</span></span><span class=line><span class=cl>    | hex hexs {% (data) =&gt; data.join(&#34;&#34;) %}
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>hex -&gt; [0-9a-fA-F] {% (data) =&gt; data[0].toLowerCase() %}
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>digits 
</span></span><span class=line><span class=cl>    -&gt; digit {% id %}
</span></span><span class=line><span class=cl>    | digit digits {% (data) =&gt; data.join(&#34;&#34;) %}
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>digit -&gt; [0-9]   {% id %}
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>_ 
</span></span><span class=line><span class=cl>    -&gt; [ \t\r\n]:*
</span></span><span class=line><span class=cl>    | _ &#34;#&#34; [^\r\n]:* &#34;\n&#34; _
</span></span><span class=line><span class=cl>    | _ &#34;#&#34; [^\r\n]:* &#34;\r&#34; _
</span></span></code></pre></td></tr></table></div></div><p>이를 nearleyc 를 이용하여 빌드를 하면 js 파일이 생성된다.</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ nearleyc -o parser.js parser.ne
</span></span></code></pre></td></tr></table></div></div><h3 id=parser-동작-검증 class=headerLink><a href=#parser-%eb%8f%99%ec%9e%91-%ea%b2%80%ec%a6%9d class=header-mark></a>Parser 동작 검증</h3><p>생성된 parser.js 가 정상적으로 수행하는지 확인하려면 <a href=https://nearley.js.org/docs/tooling#nearley-test-exploring-a-parser-interactively target=_blank rel="noopener noreferrer">nearley-test</a> 로 확인해 볼 수 있다.</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ cat input/test.conf <span class=p>|</span> nearley-test parser.js
</span></span><span class=line><span class=cl>...
</span></span><span class=line><span class=cl>Parse results:
</span></span><span class=line><span class=cl><span class=o>[</span>
</span></span><span class=line><span class=cl>  <span class=o>{</span>
</span></span><span class=line><span class=cl>    templates: <span class=o>[</span>
</span></span><span class=line><span class=cl>      <span class=o>{</span>
</span></span><span class=line><span class=cl>        type: <span class=s1>&#39;TEMPLATE&#39;</span>,
</span></span><span class=line><span class=cl>        name: <span class=s1>&#39;topic/test1&#39;</span>,
</span></span><span class=line><span class=cl>        data: <span class=o>[</span>
</span></span><span class=line><span class=cl>          <span class=o>{</span> type: <span class=s1>&#39;I8&#39;</span>, length: 0, name: <span class=s1>&#39;temperature&#39;</span> <span class=o>}</span>,
</span></span><span class=line><span class=cl>          <span class=o>{</span> type: <span class=s1>&#39;U8&#39;</span>, length: 0, name: <span class=s1>&#39;humidity&#39;</span> <span class=o>}</span>,
</span></span><span class=line><span class=cl>          <span class=o>{</span> type: <span class=s1>&#39;U16&#39;</span>, length: 0, name: <span class=s1>&#39;pressure&#39;</span> <span class=o>}</span>,
</span></span><span class=line><span class=cl>          <span class=o>{</span> type: <span class=s1>&#39;U32&#39;</span>, length: 0, name: <span class=s1>&#39;timestamp&#39;</span> <span class=o>}</span>,
</span></span><span class=line><span class=cl>          <span class=o>{</span> type: <span class=s1>&#39;FIX_STR&#39;</span>, length: 12, name: <span class=s1>&#39;name&#39;</span> <span class=o>}</span>
</span></span><span class=line><span class=cl>        <span class=o>]</span>
</span></span><span class=line><span class=cl>      <span class=o>}</span>,
</span></span><span class=line><span class=cl>      <span class=o>{</span>
</span></span><span class=line><span class=cl>        type: <span class=s1>&#39;TEMPLATE&#39;</span>,
</span></span><span class=line><span class=cl>        name: <span class=s1>&#39;topic/array_object&#39;</span>,
</span></span><span class=line><span class=cl>        data: <span class=o>[</span>
</span></span><span class=line><span class=cl>          <span class=o>{</span> type: <span class=s1>&#39;FIX_STR&#39;</span>, length: 12, name: <span class=s1>&#39;name&#39;</span> <span class=o>}</span>,
</span></span><span class=line><span class=cl>          <span class=o>{</span>
</span></span><span class=line><span class=cl>            type: <span class=s1>&#39;ARRAY&#39;</span>,
</span></span><span class=line><span class=cl>            name: <span class=s1>&#39;node&#39;</span>,
</span></span><span class=line><span class=cl>            length: 4,
</span></span><span class=line><span class=cl>            data: <span class=o>[</span>
</span></span><span class=line><span class=cl>              <span class=o>{</span> type: <span class=s1>&#39;FIX_STR&#39;</span>, length: 12, name: <span class=s1>&#39;subname&#39;</span> <span class=o>}</span>,
</span></span><span class=line><span class=cl>              <span class=o>{</span>
</span></span><span class=line><span class=cl>                type: <span class=s1>&#39;OBJECT&#39;</span>,
</span></span><span class=line><span class=cl>                name: <span class=s1>&#39;info&#39;</span>,
</span></span><span class=line><span class=cl>                data: <span class=o>[</span>
</span></span><span class=line><span class=cl>                  <span class=o>{</span> type: <span class=s1>&#39;I8&#39;</span>, length: 0, name: <span class=s1>&#39;temperature&#39;</span> <span class=o>}</span>,
</span></span><span class=line><span class=cl>                  <span class=o>{</span> type: <span class=s1>&#39;U8&#39;</span>, length: 0, name: <span class=s1>&#39;humidity&#39;</span> <span class=o>}</span>
</span></span><span class=line><span class=cl>                <span class=o>]</span>
</span></span><span class=line><span class=cl>              <span class=o>}</span>
</span></span><span class=line><span class=cl>            <span class=o>]</span>
</span></span><span class=line><span class=cl>          <span class=o>}</span>
</span></span><span class=line><span class=cl>        <span class=o>]</span>
</span></span><span class=line><span class=cl>      <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=o>]</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>]</span>
</span></span></code></pre></td></tr></table></div></div><p>위의 결과와 같이 Nearley <a href=https://nearley.js.org/docs/grammar#postprocessors target=_blank rel="noopener noreferrer">postprocessor</a> 에 <code>{% %}</code> 문 안의 코드 추가로 간단하게 JSON 형식으로 구조화된 데이타를 생성할 수 있다.
이를 이용하여 바이너리 형식으로 패킹된 데이타나 C 소스 파일 형식으로 출력만 하면 된다.</p><p><a href=https://nearley.js.org/docs/tooling#nearley-railroad-automagical-railroad-diagrams target=_blank rel="noopener noreferrer">nearley-railroad</a>로 비주얼하게 보면 아래 링크와 같다.</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>nearley-railroad parser.ne -o grammar.html
</span></span></code></pre></td></tr></table></div></div><p><a href=/posts/nearley-builder-and-loader/grammar.html rel>Railroad Diagram</a></p><h3 id=바이너리로-변환 class=headerLink><a href=#%eb%b0%94%ec%9d%b4%eb%84%88%eb%a6%ac%eb%a1%9c-%eb%b3%80%ed%99%98 class=header-mark></a>바이너리로 변환</h3><p>위와 같이 파싱된 정보를 이용하여 다음과 같은 바이너리 데이타로 변환한다.</p><ul><li>String 만 추출하여 별도의 string table 만듬</li><li>파싱된 각 element 정보를 패킹</li><li>위 정보를 헤더를 추가하여 바이너리로 패킹</li></ul><p>위 코드는 <a href=https://github.com/humminglab/nearley-dev-conf/blob/main/builder/index.js target=_blank rel="noopener noreferrer">index.js</a> 로 구현되어 있다. 참조를 위해서는 이 파일 보다는 빌더안에 있는 <a href=https://github.com/humminglab/nearley-dev-conf/blob/main/loader/loader.c target=_blank rel="noopener noreferrer">loader.c</a>로 읽어들이는 부분을 더 이해하기 좋다.</p><h2 id=빌더-만들기 class=headerLink><a href=#%eb%b9%8c%eb%8d%94-%eb%a7%8c%eb%93%a4%ea%b8%b0 class=header-mark></a>빌더 만들기</h2><p>입력 파일로 최종 원하는 C 소스 코드와 바이너리로 패킹된 데이타는 아래 링크에 있는 소스코드와 같이 구현한다.</p><ul><li><a href=https://github.com/humminglab/nearley-dev-conf/blob/main/loader/loader.c target=_blank rel="noopener noreferrer">loader.c</a></li></ul><p>코드는 간단하게 바이너리 정보를 읽어서 원 소스 파일과 유사한 형태로 결과를 출력한다.</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>Header ID: 0x5aa5
</span></span><span class=line><span class=cl>Total size: 226
</span></span><span class=line><span class=cl>CRC16: 0x3244
</span></span><span class=line><span class=cl>Number of strings: 10
</span></span><span class=line><span class=cl>Number of templates: 2
</span></span><span class=line><span class=cl>Offset string index: 18
</span></span><span class=line><span class=cl>Offset string table: 40
</span></span><span class=line><span class=cl>Offset template index: 134
</span></span><span class=line><span class=cl>Offset template table: 140
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>========================================
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>topic/test1
</span></span><span class=line><span class=cl>{
</span></span><span class=line><span class=cl> temperature I8;
</span></span><span class=line><span class=cl> humidity U8;
</span></span><span class=line><span class=cl> pressure U16;
</span></span><span class=line><span class=cl> timestamp U32;
</span></span><span class=line><span class=cl> name STR[12];
</span></span><span class=line><span class=cl>}
</span></span><span class=line><span class=cl>topic/array_object
</span></span><span class=line><span class=cl>{
</span></span><span class=line><span class=cl> name STR[12];
</span></span><span class=line><span class=cl> node ARRAY[4] {
</span></span><span class=line><span class=cl>  subname STR[12];
</span></span><span class=line><span class=cl>  info OBJECT {
</span></span><span class=line><span class=cl>   temperature I8;
</span></span><span class=line><span class=cl>   humidity U8;
</span></span><span class=line><span class=cl>  };
</span></span><span class=line><span class=cl> };
</span></span><span class=line><span class=cl>}
</span></span></code></pre></td></tr></table></div></div><p>Host, WiFi IoT 모듈 모두 제한된 기기에서 상대적으로 복잡한 동적 설정 정보를 사용하는 경우 위와 같은 방법을 사용하게 되면 적은 메모리에서 효율적으로 사용 할 수 있을 것이다.</p></div><div class=post-footer id=post-footer><div class=post-info><div class=post-info-line><div class=post-info-mod><span>Updated on 2021-01-04</span></div><div class=post-info-license></div></div><div class=post-info-line><div class=post-info-md></div><div class=post-info-share><span></span></div></div></div><div class=post-info-more><section class=post-tags><i class="fas fa-tags fa-fw"></i>&nbsp;<a href=/tags/nearley/>Nearley</a>,&nbsp;<a href=/tags/parser/>Parser</a>,&nbsp;<a href=/tags/javascript/>JavaScript</a>,&nbsp;<a href=/tags/c/>C</a></section><section><span><a href=javascript:void(0); onclick=window.history.back()>Back</a></span>&nbsp;|&nbsp;<span><a href=/>Home</a></span></section></div><div class=post-nav><a href=/posts/yocto-project-on-orange-pi-1/ class=prev rel=prev title="Yocto Project 개발하기(1) - Orange Pi 보드 빌드"><i class="fas fa-angle-left fa-fw"></i>Yocto Project 개발하기(1) - Orange Pi 보드 빌드</a>
<a href=/posts/yocto-project-on-orange-pi-2/ class=next rel=next title="Yocto Project 개발하기(2) - Custom Layer 만들기">Yocto Project 개발하기(2) - Custom Layer 만들기<i class="fas fa-angle-right fa-fw"></i></a></div></div><div id=comments><div id=giscus></div><noscript>Please enable JavaScript to view the comments powered by <a href=https://giscus.app/>giscus</a>.</noscript></div></article></div></main><footer class=footer><div class=footer-container><div class=footer-line><i class="far fa-copyright fa-fw"></i><span itemprop=copyrightYear>2023</span><span class=author itemprop=copyrightHolder>&nbsp;<a href=https://www.humminglab.io target=_blank rel="noopener noreferrer">HummingLab</a></span>&nbsp;|&nbsp;<span class=license><a rel="license external nofollow noopener noreffer" href=https://creativecommons.org/licenses/by-nc/4.0/ target=_blank>CC BY-NC 4.0</a></span></div><div class=footer-line></div><div class=footer-line></div></div></footer></div><div id=fixed-buttons><a href=#back-to-top id=back-to-top-button class=fixed-button title="Back to Top"><i class="fas fa-arrow-up fa-fw"></i>
</a><a href=# id=view-comments class=fixed-button title="View Comments"><i class="fas fa-comment fa-fw"></i></a></div><div class=assets><link rel=stylesheet href=/lib/katex/katex.min.css><link rel=preload as=style onload='this.onload=null,this.rel="stylesheet"' href=/lib/katex/copy-tex.min.css><noscript><link rel=stylesheet href=/lib/katex/copy-tex.min.css></noscript><script type=text/javascript>window.config={code:{copyTitle:"Copy to clipboard",maxShownLines:50},comment:{giscus:{darkTheme:"dark",dataCategory:"Announcements",dataCategoryId:"DIC_kwDOGdk00s4CAGXN",dataEmitMetadata:"0",dataInputPosition:"bottom",dataLang:"en",dataMapping:"pathname",dataReactionsEnabled:"1",dataRepo:"humminglab/blog.humminglab.io",dataRepoId:"R_kgDOGdk00g",dataStrict:"0",lightTheme:"light"}},math:{delimiters:[{display:!0,left:"$$",right:"$$"},{display:!0,left:"\\[",right:"\\]"},{display:!1,left:"$",right:"$"},{display:!1,left:"\\(",right:"\\)"}],strict:!1}}</script><script type=text/javascript src=/js/giscus.min.js defer></script><script type=text/javascript src=/lib/clipboard/clipboard.min.js></script><script type=text/javascript src=/lib/katex/katex.min.js defer></script><script type=text/javascript src=/lib/katex/auto-render.min.js defer></script><script type=text/javascript src=/lib/katex/copy-tex.min.js defer></script><script type=text/javascript src=/lib/katex/mhchem.min.js defer></script><script type=text/javascript src=/js/katex.min.js defer></script><script type=text/javascript src=/js/theme.min.js defer></script><script type=text/javascript>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","UA-83257319-3",{anonymize_ip:!0})</script><script type=text/javascript src="https://www.googletagmanager.com/gtag/js?id=UA-83257319-3" async></script></div></body></html>